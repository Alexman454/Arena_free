<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Game Arena</title>
	<style>
    canvas {
		background: #222;
		display: block;
		margin: 0 auto;
    }
	h1 {
		text-align: center;
	}
  </style>
</head>
<body>
    <h1>Arena 2D</h1>
    <canvas id="game" width="800" height="600"></canvas>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
    const socket = io("http://26.252.121.144:3000");

	const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    let playerId = null;
    const players = {};
    const bullets = [];

    socket.on("init", (data) => {
      playerId = data.id;
      Object.assign(players, data.players);
        draw();
        gameLoop();

    });
    socket.on("bulletFired", (bullet) => {
        bullets.push(bullet);
    });

    socket.on("playerJoined", ({ id, player }) => {
      players[id] = player;
    });

        socket.on("update", ({ id, x, y, hp }) => {
            if (players[id]) {
                players[id].x = x;
                players[id].y = y;
                if (hp !== undefined) players[id].hp = hp;
            }
        });

    socket.on("playerLeft", (id) => {
      delete players[id];
    });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const id in players) {
                const p = players[id];
                updateBullets();
                // Рисуем игрока
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 30, 30);
                ctx.fillStyle = "red";
                ctx.fillRect(p.x, p.y - 10, 30, 5);
                ctx.fillStyle = "lime";
                ctx.fillRect(p.x, p.y - 10, (p.hp / 100) * 30, 5);
                // Обводка для текущего игрока
                if (id === playerId) {
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(p.x, p.y, 30, 30);
                }
            }

            requestAnimationFrame(draw);
        }

    let speed = 5;
        const keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false,
        };

        document.addEventListener("keydown", (e) => {
            const key = e.key.toLowerCase();

            // Обработка стрельбы по WASD
            if (["w", "a", "s", "d"].includes(key)) {
                const me = players[playerId];
                if (!me) return;

                let dir = { x: 0, y: 0 };
                if (key === "w") dir.y = -1;
                if (key === "s") dir.y = 1;
                if (key === "a") dir.x = -1;
                if (key === "d") dir.x = 1;

                const bullet = {
                    x: me.x + 15,
                    y: me.y + 15,
                    dir
                };

                console.log("Emitting shoot:", bullet);
                socket.emit("shoot", bullet);
            }

            // Обработка движения стрелками
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
            }
        });



        document.addEventListener("keyup", (e) => {
            if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
        });

        function gameLoop() {
            const me = players[playerId];
            if (!me) return;

            let moved = false;

            if (keys.ArrowUp) {
                me.y -= speed;
                moved = true;
            }
            if (keys.ArrowDown) {
                me.y += speed;
                moved = true;
            }
            if (keys.ArrowLeft) {
                me.x -= speed;
                moved = true;
            }
            if (keys.ArrowRight) {
                me.x += speed;
                moved = true;
            }

            // Границы карты
            me.x = Math.max(0, Math.min(canvas.width - 30, me.x));
            me.y = Math.max(0, Math.min(canvas.height - 30, me.y));

            // Отправляем на сервер только если двигался
            if (moved) {
                socket.emit("move", { x: me.x, y: me.y });
            }
            // Рисуем пули
            ctx.fillStyle = "yellow";
            for (const b of bullets) {
                ctx.beginPath();
                ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            requestAnimationFrame(gameLoop);
        }
        function updateBullets() {
            for (const b of bullets) {
                b.x += b.dir.x * 8;
                b.y += b.dir.y * 8;
            }

            // Удаление вышедших за экран
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
                    bullets.splice(i, 1);
                }
            }
        }
    </script>
</body>
</html>